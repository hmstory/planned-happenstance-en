<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create My Story - Planned Happenstance</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- React 18 -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- marked.js for markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        * { font-family: 'Inter', sans-serif; }
        .markdown-content h1 { @apply text-2xl font-bold text-cyan-400 mt-4 mb-2; }
        .markdown-content h2 { @apply text-xl font-bold text-cyan-400 mt-3 mb-2; }
        .markdown-content h3 { @apply text-lg font-semibold text-cyan-300 mt-2 mb-1; }
        .markdown-content h4 { @apply text-base font-semibold text-cyan-300 mt-2 mb-1; }
        .markdown-content p { @apply text-slate-300 mb-2 leading-relaxed; }
        .markdown-content ul, .markdown-content ol { @apply text-slate-300 mb-2 ml-4; }
        .markdown-content li { @apply mb-1; }
        .markdown-content strong { @apply text-cyan-300 font-semibold; }
        .markdown-content em { @apply text-cyan-200; }
        .markdown-content code { @apply bg-slate-700 text-cyan-300 px-2 py-1 rounded text-sm; }
        .markdown-content pre { @apply bg-slate-800 p-3 rounded mb-2 overflow-x-auto; }
        .markdown-content hr { @apply border-slate-700 my-4; }
        .spinner { border: 4px solid rgba(241, 245, 249, 0.1); border-top: 4px solid rgb(34, 211, 238); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .progress-bar { height: 4px; background-color: rgb(15, 23, 42); border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, rgb(34, 211, 238), rgb(0, 188, 212)); transition: width 0.3s ease; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100">
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        function App() {
            const [stage, setStage] = useState('intro');
            const [userName, setUserName] = useState('');
            const [currentEvent, setCurrentEvent] = useState(0);
            const [events, setEvents] = useState(Array(4).fill(null).map(() => ({
                period: '',
                title: '',
                situation: '',
                action: ''
            })));
            const [analysis, setAnalysis] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState('');
            
            const handleNameSubmit = () => {
                if (userName.trim()) { setStage('input'); }
            };
            
            const handleEventChange = (field, value) => {
                const newEvents = [...events];
                newEvents[currentEvent][field] = value;
                setEvents(newEvents);
            };
            
            const isEventComplete = () => {
                const event = events[currentEvent];
                return event.period && event.title && event.situation && event.action;
            };
            
            const handleNext = () => {
                if (!isEventComplete()) { setError('Please fill in all fields'); return; }
                if (currentEvent < 3) { setCurrentEvent(currentEvent + 1); setError(''); }
                else { handleAnalyze(); }
            };
            
            const handlePrevious = () => {
                if (currentEvent > 0) { setCurrentEvent(currentEvent - 1); setError(''); }
            };
            
            const handleAnalyze = async () => {
                if (!isEventComplete()) { setError('Please fill in all fields'); return; }
                setStage('analyzing'); setIsLoading(true); setError('');
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 60000);
                    const response = await fetch('/api/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ events: events, requestStructuredData: true }),
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    if (!response.ok) throw new Error(`API error: ${response.status}`);
                    const data = await response.json();
                    setAnalysis(data.analysis || data.message || '');
                    setStage('result');
                } catch (err) {
                    setError(err.message || 'Failed to analyze. Please try again.');
                    setStage('input');
                }
                setIsLoading(false);
            };
            
            const handleDownloadImage = async () => {
                const element = document.getElementById('journey-map-content');
                if (element) {
                    try {
                        const canvas = await html2canvas(element, { backgroundColor: '#0f172a', scale: 2 });
                        const link = document.createElement('a');
                        link.href = canvas.toDataURL('image/png');
                        link.download = `${userName}-planned-happenstance-journey.png`;
                        link.click();
                    } catch (err) { setError('Failed to download image'); }
                }
            };
            
            const handleStartOver = () => {
                setStage('intro'); setUserName(''); setCurrentEvent(0);
                setEvents(Array(4).fill(null).map(() => ({ period: '', title: '', situation: '', action: '' })));
                setAnalysis(''); setError('');
            };
            
            return (
                <div class="min-h-screen bg-slate-900 text-slate-100">
                    <div class="bg-slate-800 border-b border-slate-700 px-6 py-4">
                        <div class="max-w-6xl mx-auto flex justify-between items-center">
                            <h1 class="text-xl font-bold text-cyan-400">Planned Happenstance</h1>
                            <a href="https://planned-happenstance.vercel.app/my_story_ai.html" class="text-sm text-cyan-400 hover:text-cyan-300 transition">
                                ÌïúÍµ≠Ïñ¥ / English ‚Üó
                            </a>
                        </div>
                    </div>
                    
                    <div class="max-w-4xl mx-auto p-6">
                        {stage === 'intro' && (
                            <div class="text-center py-12">
                                <h1 class="text-4xl font-bold text-cyan-400 mb-2">Create My Story</h1>
                                <p class="text-xl text-cyan-500 mb-8">My Planned Happenstance Journey</p>
                                <div class="bg-slate-800 rounded-lg p-8 mb-8 text-left">
                                    <p class="text-slate-300 leading-relaxed mb-6">Think of moments in your life where chance events influenced your career. Enter 4 key events, and AI will automatically analyze which skills (Curiosity, Persistence, Flexibility, Optimism, Risk-taking) were manifested.</p>
                                </div>
                                <div class="bg-slate-800 rounded-lg p-6 max-w-sm mx-auto">
                                    <input type="text" placeholder="Enter your name or nickname" value={userName} onChange={(e) => setUserName(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && userName.trim() && handleNameSubmit()} class="w-full bg-slate-700 border border-slate-600 rounded px-4 py-2 text-slate-100 placeholder-slate-400 focus:outline-none focus:border-cyan-400 mb-4" />
                                    <button onClick={handleNameSubmit} disabled={!userName.trim()} class="w-full bg-cyan-500 hover:bg-cyan-400 disabled:bg-slate-600 disabled:cursor-not-allowed text-slate-900 font-semibold py-2 px-4 rounded transition">Start ‚Üí</button>
                                </div>
                            </div>
                        )}
                        {stage === 'input' && (
                            <div class="py-8">
                                <div class="mb-8">
                                    <h2 class="text-2xl font-bold text-cyan-400 mb-4">Event {currentEvent + 1}/4</h2>
                                    <div class="progress-bar"><div class="progress-fill" style={{width: `${((currentEvent + 1) / 4) * 100}%`}}></div></div>
                                </div>
                                <div class="bg-slate-800 rounded-lg p-8 space-y-6">
                                    <div>
                                        <label class="block text-sm font-semibold text-cyan-400 mb-2">Period</label>
                                        <input type="text" placeholder="e.g., College sophomore, Summer 2015" value={events[currentEvent].period} onChange={(e) => handleEventChange('period', e.target.value)} class="w-full bg-slate-700 border border-slate-600 rounded px-4 py-2 text-slate-100 placeholder-slate-400 focus:outline-none focus:border-cyan-400" />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-cyan-400 mb-2">Event Title</label>
                                        <input type="text" placeholder="e.g., Accidentally joined a startup club" value={events[currentEvent].title} onChange={(e) => handleEventChange('title', e.target.value)} class="w-full bg-slate-700 border border-slate-600 rounded px-4 py-2 text-slate-100 placeholder-slate-400 focus:outline-none focus:border-cyan-400" />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-cyan-400 mb-2">Chance Event</label>
                                        <textarea placeholder="What chance event happened?" value={events[currentEvent].situation} onChange={(e) => handleEventChange('situation', e.target.value)} rows="4" class="w-full bg-slate-700 border border-slate-600 rounded px-4 py-2 text-slate-100 placeholder-slate-400 focus:outline-none focus:border-cyan-400 resize-none"></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-cyan-400 mb-2">My Action</label>
                                        <textarea placeholder="How did you respond to the situation?" value={events[currentEvent].action} onChange={(e) => handleEventChange('action', e.target.value)} rows="4" class="w-full bg-slate-700 border border-slate-600 rounded px-4 py-2 text-slate-100 placeholder-slate-400 focus:outline-none focus:border-cyan-400 resize-none"></textarea>
                                    </div>
                                    {error && (<div class="bg-red-900 border border-red-700 text-red-200 px-4 py-2 rounded">{error}</div>)}
                                </div>
                                <div class="flex justify-between mt-8">
                                    <button onClick={handlePrevious} disabled={currentEvent === 0} class="bg-slate-700 hover:bg-slate-600 disabled:bg-slate-800 disabled:cursor-not-allowed text-slate-100 font-semibold py-2 px-6 rounded transition">‚Üê Previous</button>
                                    <button onClick={handleNext} class="bg-cyan-500 hover:bg-cyan-400 text-slate-900 font-semibold py-2 px-6 rounded transition">{currentEvent === 3 ? 'Start AI Analysis' : 'Next ‚Üí'}</button>
                                </div>
                            </div>
                        )}
                        {stage === 'analyzing' && (
                            <div class="flex flex-col items-center justify-center py-20">
                                <div class="spinner mb-6"></div>
                                <p class="text-lg text-slate-300">AI is analyzing...</p>
                            </div>
                        )}
                        {stage === 'result' && (
                            <div class="py-8">
                                <h2 class="text-3xl font-bold text-cyan-400 mb-2">{userName}'s AI Analysis Results</h2>
                                <p class="text-slate-400 mb-8">Based on Planned Happenstance Theory</p>
                                <div class="bg-slate-800 rounded-lg p-8 mb-8 markdown-content">
                                    <div dangerouslySetInnerHTML={{ __html: marked.parse(analysis) }}></div>
                                </div>
                                <div class="flex gap-4 flex-wrap">
                                    <button onClick={() => setStage('journey_map')} class="bg-cyan-500 hover:bg-cyan-400 text-slate-900 font-semibold py-2 px-6 rounded transition">View Journey Map üó∫Ô∏è</button>
                                    <button onClick={handleStartOver} class="bg-slate-700 hover:bg-slate-600 text-slate-100 font-semibold py-2 px-6 rounded transition">Start Over</button>
                                </div>
                            </div>
                        )}
                        {stage === 'journey_map' && (
                            <div class="py-8">
                                <h2 class="text-3xl font-bold text-cyan-400 mb-8">{userName}'s Journey Timeline</h2>
                                <div id="journey-map-content" class="bg-slate-800 rounded-lg p-8 mb-8">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        {events.map((event, idx) => (
                                            <div key={idx} class="bg-slate-700 rounded-lg p-6 border border-slate-600">
                                                <div class="text-sm text-cyan-400 font-semibold mb-2">Event {idx + 1}</div>
                                                <h3 class="text-lg font-bold text-cyan-300 mb-4">{event.title}</h3>
                                                <div class="space-y-3">
                                                    <div class="text-sm text-slate-300"><span class="text-cyan-400 font-semibold">üìÖ Period:</span> {event.period}</div>
                                                    <div class="text-sm text-slate-300"><span class="text-cyan-400 font-semibold">‚ö° Chance Event:</span><p class="mt-1">{event.situation}</p></div>
                                                    <div class="text-sm text-slate-300"><span class="text-cyan-400 font-semibold">üé¨ My Action:</span><p class="mt-1">{event.action}</p></div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <div class="flex gap-4 flex-wrap">
                                    <button onClick={handleDownloadImage} class="bg-cyan-500 hover:bg-cyan-400 text-slate-900 font-semibold py-2 px-6 rounded transition">üì• Download Image</button>
                                    <button onClick={() => setStage('result')} class="bg-slate-700 hover:bg-slate-600 text-slate-100 font-semibold py-2 px-6 rounded transition">‚Üê Analysis Results</button>
                                    <button onClick={handleStartOver} class="bg-slate-700 hover:bg-slate-600 text-slate-100 font-semibold py-2 px-6 rounded transition">Start Over</button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>