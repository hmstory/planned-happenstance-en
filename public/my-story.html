<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create My Story - Planned Happenstance</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
        }
        .app-container { max-width: 700px; margin: 0 auto; padding: 40px 20px; }
        .app-container-wide { max-width: 1200px; margin: 0 auto; padding: 40px 20px; }
        .header { text-align: center; margin-bottom: 40px; }
        .main-title { font-size: 32px; font-weight: 700; color: #06b6d4; margin-bottom: 12px; }
        .subtitle { font-size: 16px; color: #94a3b8; }
        .lang-switch {
            position: fixed; top: 16px; right: 24px; z-index: 50;
            font-size: 14px; color: #06b6d4; text-decoration: none;
        }
        .lang-switch:hover { color: #22d3ee; }
        .intro-box {
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid rgba(6, 182, 212, 0.3);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 40px;
        }
        .intro-text {
            color: #e2e8f0; font-size: 16px; line-height: 1.7; margin-bottom: 24px;
        }
        .btn-start {
            width: 100%;
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: white; padding: 16px 32px; border-radius: 12px;
            font-size: 16px; font-weight: 600; border: none; cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-start:hover { transform: translateY(-2px); }
        .btn-start:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .progress-bar {
            background: rgba(30, 41, 59, 0.6); border-radius: 12px;
            padding: 20px; margin-bottom: 30px;
        }
        .progress-text { font-size: 14px; color: #94a3b8; margin-bottom: 12px; text-align: center; }
        .progress-track { background: rgba(71, 85, 105, 0.5); height: 8px; border-radius: 4px; }
        .progress-fill {
            background: linear-gradient(90deg, #06b6d4 0%, #0891b2 100%);
            height: 100%; transition: width 0.3s ease;
        }
        .event-form {
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid rgba(6, 182, 212, 0.3);
            border-radius: 16px; padding: 32px; margin-bottom: 30px;
        }
        .form-group { margin-bottom: 24px; }
        .form-label { display: block; font-size: 14px; font-weight: 600; color: #06b6d4; margin-bottom: 8px; }
        .form-input, .form-textarea {
            width: 100%; background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(71, 85, 105, 0.5); border-radius: 8px;
            padding: 12px 16px; font-size: 15px; color: #e2e8f0; font-family: inherit;
        }
        .form-input:focus, .form-textarea:focus {
            outline: none; border-color: #06b6d4;
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
        }
        .form-textarea { resize: vertical; min-height: 100px; }
        .button-group { display: flex; gap: 12px; margin-top: 30px; }
        .btn {
            flex: 1; padding: 14px 24px; border-radius: 10px;
            font-size: 15px; font-weight: 600; border: none; cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); color: white;
        }
        .btn-primary:hover { transform: translateY(-2px); }
        .btn-secondary {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(6, 182, 212, 0.3); color: #06b6d4;
        }
        .btn-secondary:hover { background: rgba(30, 41, 59, 0.8); }
        .analyzing-screen { text-align: center; padding: 60px 20px; }
        .spinner {
            width: 60px; height: 60px;
            border: 4px solid rgba(6, 182, 212, 0.2);
            border-top: 4px solid #06b6d4; border-radius: 50%;
            animation: spin 1s linear infinite; margin: 0 auto 24px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .analyzing-text { font-size: 18px; color: #e2e8f0; }
        .result-container {
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid rgba(6, 182, 212, 0.3);
            border-radius: 16px; padding: 32px;
        }
        .result-title {
            font-size: 24px; font-weight: 700; color: #06b6d4;
            margin-bottom: 30px; text-align: center;
        }
        .markdown-content { color: #e2e8f0; font-size: 15px; line-height: 1.8; }
        .markdown-content h2 {
            font-size: 20px; font-weight: 700; color: #06b6d4;
            margin: 32px 0 16px 0; padding-bottom: 8px;
            border-bottom: 1px solid rgba(6, 182, 212, 0.3);
        }
        .markdown-content h2:first-child { margin-top: 0; }
        .markdown-content h3 { font-size: 16px; font-weight: 600; color: #94a3b8; margin: 20px 0 12px 0; }
        .markdown-content p { margin-bottom: 12px; }
        .markdown-content strong { color: #fbbf24; font-weight: 600; }
        .markdown-content ul { margin: 12px 0; padding-left: 20px; }
        .markdown-content li { margin-bottom: 8px; color: #cbd5e1; }
        .markdown-content hr { border: none; border-top: 1px solid rgba(71, 85, 105, 0.5); margin: 24px 0; }
        .markdown-content code { background: rgba(6, 182, 212, 0.1); padding: 2px 6px; border-radius: 4px; font-family: monospace; }
        .markdown-content table { width: 100%; border-collapse: collapse; margin: 16px 0; font-size: 13px; display: block; overflow-x: auto; white-space: nowrap; }
        .markdown-content th, .markdown-content td { border: 1px solid rgba(71, 85, 105, 0.5); padding: 8px 12px; text-align: left; }
        .markdown-content th { background: rgba(6, 182, 212, 0.2); color: #06b6d4; font-weight: 600; }
        .markdown-content td { background: rgba(15, 23, 42, 0.4); }
        .journey-timeline { position: relative; padding: 40px 0; }
        .journey-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; position: relative; }
        .journey-point { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; }
        .journey-number {
            width: 40px; height: 40px; border-radius: 50%;
            border: 4px solid rgba(15, 23, 42, 0.9);
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; font-weight: 700; color: white;
            position: relative; z-index: 2;
        }
        .journey-card {
            background: rgba(15, 23, 42, 0.6); border-radius: 16px;
            padding: 24px; min-height: 240px; transition: all 0.3s ease; cursor: pointer;
        }
        .journey-card:hover { transform: translateY(-8px); }
        .journey-period { font-size: 12px; color: #94a3b8; margin-bottom: 12px; font-weight: 600; }
        .journey-title { font-size: 16px; font-weight: 600; color: #e2e8f0; margin-bottom: 16px; line-height: 1.5; }
        .journey-section { margin-bottom: 12px; }
        .journey-label { font-size: 12px; color: #06b6d4; font-weight: 600; margin-bottom: 4px; }
        .journey-text { font-size: 13px; color: #cbd5e1; line-height: 1.6; }
        @media (max-width: 768px) {
            .journey-grid { grid-template-columns: 1fr; gap: 30px; }
            .journey-card { min-height: auto; }
            .app-container-wide { max-width: 100%; padding: 20px 16px; }
            .main-title { font-size: 24px; }
            .subtitle { font-size: 14px; }
            .markdown-content table { font-size: 11px; }
            .markdown-content th, .markdown-content td { padding: 6px 8px; }
        }
        @media (min-width: 769px) and (max-width: 1024px) {
            .journey-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script type="text/babel">
        const { useState } = React;

        function MyStoryApp() {
            const [stage, setStage] = useState('intro');
            const [currentEvent, setCurrentEvent] = useState(1);
            const [userName, setUserName] = useState('');
            const [events, setEvents] = useState([
                { period: '', title: '', situation: '', action: '' },
                { period: '', title: '', situation: '', action: '' },
                { period: '', title: '', situation: '', action: '' },
                { period: '', title: '', situation: '', action: '' }
            ]);
            const [analysis, setAnalysis] = useState('');
            const [journeySkills, setJourneySkills] = useState([]);

            const resetApp = () => {
                setStage('intro');
                setCurrentEvent(1);
                setUserName('');
                setEvents([
                    { period: '', title: '', situation: '', action: '' },
                    { period: '', title: '', situation: '', action: '' },
                    { period: '', title: '', situation: '', action: '' },
                    { period: '', title: '', situation: '', action: '' }
                ]);
                setAnalysis('');
                setJourneySkills([]);
            };

            const downloadJourneyMap = async () => {
                const journeyElement = document.getElementById('journey-map-container');
                if (!journeyElement) { alert('Journey map not found.'); return; }
                if (typeof html2canvas === 'undefined') { alert('Image library not loaded. Please refresh.'); return; }
                try {
                    const canvas = await html2canvas(journeyElement, {
                        backgroundColor: '#0f172a', scale: 2, logging: false, useCORS: true, allowTaint: true
                    });
                    canvas.toBlob((blob) => {
                        if (!blob) { alert('Failed to generate image.'); return; }
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.download = `${userName || 'my'}_planned_happenstance_journey.png`;
                        link.href = url;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                    }, 'image/png');
                } catch (error) {
                    console.error('Download error:', error);
                    alert('Download failed: ' + error.message);
                }
            };

            const updateEvent = (field, value) => {
                const newEvents = [...events];
                newEvents[currentEvent - 1][field] = value;
                setEvents(newEvents);
            };

            const handleNext = () => {
                const current = events[currentEvent - 1];
                if (!current.period.trim() || !current.title.trim() || !current.situation.trim() || !current.action.trim()) {
                    alert('Please fill in all fields.');
                    return;
                }
                if (currentEvent < 4) {
                    setCurrentEvent(currentEvent + 1);
                } else {
                    analyzeEvents();
                }
            };

            const handlePrevious = () => {
                if (currentEvent > 1) setCurrentEvent(currentEvent - 1);
            };

            const analyzeEvents = async () => {
                setStage('analyzing');
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000);

                try {
                    const response = await fetch('/api/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ events, requestStructuredData: true }),
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Server error:', response.status, errorText);
                        throw new Error(`Server error (${response.status}): ${errorText.substring(0, 100)}`);
                    }

                    const data = await response.json();
                    if (data.error) throw new Error(data.error);

                    if (!data.content || !data.content[0] || !data.content[0].text) {
                        console.error('Unexpected API response:', data);
                        throw new Error('Invalid API response format.');
                    }

                    const responseText = data.content[0].text;
                    console.log('API Response:', responseText);

                    let displayText = responseText;
                    try {
                        let jsonMatch = responseText.match(/\{"events"\s*:\s*\[[\s\S]*?\]\}/);
                        if (!jsonMatch) {
                            jsonMatch = responseText.match(/```json\s*([\s\S]*?)```/);
                            if (jsonMatch) jsonMatch[0] = jsonMatch[1];
                        }
                        if (!jsonMatch) {
                            jsonMatch = responseText.match(/\{[\s\S]*"events"[\s\S]*\}/);
                        }
                        if (jsonMatch) {
                            console.log('JSON found:', jsonMatch[0]);
                            const structuredData = JSON.parse(jsonMatch[0]);
                            setJourneySkills(structuredData.events || []);
                            displayText = responseText
                                .replace(/#{1,3}\s*.*?JSON.*?\n/gi, '')
                                .replace(/```json[\s\S]*?```/gi, '')
                                .replace(/```[\s\S]*?```/gi, '')
                                .replace(jsonMatch[0], '')
                                .replace(/\n{3,}/g, '\n\n')
                                .trim();
                        } else {
                            console.log('JSON not found, extracting from text');
                            const extractedSkills = extractSkillsFromText(responseText);
                            setJourneySkills(extractedSkills);
                        }
                    } catch (parseError) {
                        console.error('JSON parse error:', parseError);
                        const extractedSkills = extractSkillsFromText(responseText);
                        setJourneySkills(extractedSkills);
                    }

                    setAnalysis(displayText);
                    setStage('result');
                } catch (error) {
                    if (error.name === 'AbortError') {
                        alert('Analysis timed out. Please try again.');
                    } else {
                        alert('Analysis failed: ' + error.message);
                    }
                    setStage('input');
                }
            };

            const extractSkillsFromText = (text) => {
                const skillKeywords = ['Curiosity', 'Persistence', 'Flexibility', 'Optimism', 'Risk-taking'];
                const extracted = [];
                const eventSections = text.split(/##\s*Event\s*\d|Event\s*\d\s*:/i);
                console.log('Event sections found:', eventSections.length - 1);

                eventSections.forEach((section, index) => {
                    if (index === 0) return;
                    const foundSkills = [];
                    skillKeywords.forEach(skill => {
                        if (section.toLowerCase().includes(skill.toLowerCase())) {
                            foundSkills.push(skill);
                        }
                    });
                    console.log(`Event ${index} skills:`, foundSkills);
                    extracted.push({ skills: foundSkills });
                });

                while (extracted.length < 4) extracted.push({ skills: [] });
                return extracted.slice(0, 4);
            };

            const currentEventData = events[currentEvent - 1];
            const progress = (currentEvent / 4) * 100;
            const eventColors = ['#06b6d4', '#0891b2', '#0e7490', '#155e75'];

            const renderMarkdown = (text) => {
                if (!text) return '';
                try { return { __html: marked.parse(text) }; }
                catch (e) { return { __html: text }; }
            };

            if (stage === 'intro') {
                return (
                    <div className="app-container">
                        <a href="https://planned-happenstance.vercel.app/my_story_ai.html" className="lang-switch">
                            한국어 / English
                        </a>
                        <div className="header">
                            <h1 className="main-title">Create My Story</h1>
                            <p className="subtitle">My Planned Happenstance Journey</p>
                        </div>
                        <div className="intro-box">
                            <p className="intro-text">
                                Think of moments in your life where <strong style={{color: '#06b6d4'}}>chance events</strong> influenced your career.
                            </p>
                            <p className="intro-text">
                                Enter 4 key events, and AI will automatically analyze which skills (Curiosity, Persistence, Flexibility, Optimism, Risk-taking) were manifested.
                            </p>
                            <div style={{marginTop: '24px'}}>
                                <input
                                    type="text"
                                    className="form-input"
                                    placeholder="Enter your name or nickname"
                                    value={userName}
                                    onChange={(e) => setUserName(e.target.value)}
                                    style={{marginBottom: '16px'}}
                                />
                            </div>
                            <button
                                className="btn-start"
                                onClick={() => setStage('input')}
                                disabled={!userName.trim()}
                            >
                                Start →
                            </button>
                        </div>
                    </div>
                );
            }

            if (stage === 'input') {
                return (
                    <div className="app-container">
                        <div className="header">
                            <h1 className="main-title">Event {currentEvent}/4</h1>
                        </div>
                        <div className="progress-bar">
                            <p className="progress-text">Progress: {Math.round(progress)}%</p>
                            <div className="progress-track">
                                <div className="progress-fill" style={{width: `${progress}%`}}></div>
                            </div>
                        </div>
                        <div className="event-form">
                            <div className="form-group">
                                <label className="form-label">Period</label>
                                <input type="text" className="form-input" placeholder="e.g., College sophomore, Summer 2015"
                                    value={currentEventData.period} onChange={(e) => updateEvent('period', e.target.value)} />
                            </div>
                            <div className="form-group">
                                <label className="form-label">Event Title</label>
                                <input type="text" className="form-input" placeholder="e.g., Accidentally joined a startup club"
                                    value={currentEventData.title} onChange={(e) => updateEvent('title', e.target.value)} />
                            </div>
                            <div className="form-group">
                                <label className="form-label">Chance Event</label>
                                <textarea className="form-textarea" placeholder="What chance event happened?"
                                    value={currentEventData.situation} onChange={(e) => updateEvent('situation', e.target.value)} />
                            </div>
                            <div className="form-group">
                                <label className="form-label">My Action</label>
                                <textarea className="form-textarea" placeholder="How did you respond to the situation?"
                                    value={currentEventData.action} onChange={(e) => updateEvent('action', e.target.value)} />
                            </div>
                            <div className="button-group">
                                {currentEvent > 1 && (
                                    <button className="btn btn-secondary" onClick={handlePrevious}>← Previous</button>
                                )}
                                <button className="btn btn-primary" onClick={handleNext}>
                                    {currentEvent < 4 ? 'Next →' : 'Start AI Analysis'}
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (stage === 'analyzing') {
                return (
                    <div className="app-container">
                        <div className="analyzing-screen">
                            <div className="spinner"></div>
                            <p className="analyzing-text">AI is analyzing...</p>
                        </div>
                    </div>
                );
            }

            if (stage === 'result') {
                return (
                    <div className="app-container">
                        <div className="result-container">
                            <h2 className="result-title">{userName}'s AI Analysis Results</h2>
                            <div className="markdown-content" dangerouslySetInnerHTML={renderMarkdown(analysis)} />
                            <div className="button-group" style={{marginTop: '30px'}}>
                                <button className="btn btn-primary" onClick={() => setStage('journey_map')}>
                                    View Journey Map
                                </button>
                                <button className="btn btn-secondary" onClick={resetApp}>
                                    Start Over
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (stage === 'journey_map') {
                return (
                    <div className="app-container-wide">
                        <div id="journey-map-container">
                            <div className="header">
                                <h1 className="main-title">{userName}'s Planned Happenstance Journey</h1>
                                <p className="subtitle">A Career Story Shaped by Chance Events</p>
                            </div>
                            <div className="journey-timeline">
                                <div className="journey-grid">
                                    {events.map((event, index) => {
                                        const color = eventColors[index];
                                        return (
                                            <div key={index}>
                                                <div className="journey-point">
                                                    <div className="journey-number" style={{
                                                        background: color,
                                                        boxShadow: `0 0 20px ${color}40`
                                                    }}>
                                                        {index + 1}
                                                    </div>
                                                </div>
                                                <div className="journey-card" style={{ border: `2px solid ${color}40` }}>
                                                    <div className="journey-period">{event.period}</div>
                                                    <h3 className="journey-title">{event.title}</h3>
                                                    <div className="journey-section">
                                                        <div className="journey-label">Chance Event</div>
                                                        <div className="journey-text">{event.situation}</div>
                                                    </div>
                                                    <div className="journey-section">
                                                        <div className="journey-label">My Action</div>
                                                        <div className="journey-text">{event.action}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                        <div style={{textAlign: 'center', marginTop: '60px'}}>
                            <div className="button-group" style={{maxWidth: '600px', margin: '0 auto'}}>
                                <button className="btn btn-primary" onClick={downloadJourneyMap}>
                                    Download Image
                                </button>
                                <button className="btn btn-secondary" onClick={() => setStage('result')}>
                                    ← Analysis Results
                                </button>
                                <button className="btn btn-secondary" onClick={resetApp}>
                                    Start Over
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MyStoryApp />);
    </script>
</body>
</html>
